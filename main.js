!function(){"use strict";class e{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const s=document.createElement("div");s.classList.add("cell","map-tile","map-tile-"+(t=e,a=this.boardSize,0===t?"top-left":t>0&&t<7?"top":7===t?"top-right":56===t?"bottom-left":63===t?"bottom-right":t>56&&t<63?"bottom":t%a==0?"left":t%a==7?"right":"center")),s.addEventListener("mouseenter",(e=>this.onCellEnter(e))),s.addEventListener("mouseleave",(e=>this.onCellLeave(e))),s.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(s)}var t,a;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),r.style.width=`${a.character.health}%`,i.appendChild(r),s.appendChild(i),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t){this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){if(e||0===e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",(()=>{s.removeChild(i),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}var t="prairie",a="desert",s="arctic",i="mountain",r="auto",l="pointer",n="crosshair",c="not-allowed";class h{constructor(e,t){if(this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t,"Character"===new.target.name)throw new Error("Нельзя напрямую вызывать класс Character")}}class o extends h{constructor(e,t){super(e,t),this.attack=25,this.defence=25}}class d extends h{constructor(e,t){super(e,t),this.attack=40,this.defence=10}}class m extends h{constructor(e,t){super(e,t),this.attack=10,this.defence=40}}class u extends h{constructor(e,t){super(e,t),this.attack=40,this.defence=10}}class p extends h{constructor(e,t){super(e,t),this.attack=10,this.defence=10}}class g extends h{constructor(e,t){super(e,t),this.attack=25,this.defence=25}}function*f(e,t){const a=Math.floor(Math.random()*e.length),s=Math.floor(Math.random()*t)+1,i=e[a];"Bowman"===i&&(yield new o(s,"bowman")),"Swordsman"===i&&(yield new d(s,"swordsman")),"Magician"===i&&(yield new m(s,"magician")),"Undead"===i&&(yield new u(s,"undead")),"Daemon"===i&&(yield new p(s,"daemon")),"Vampire"===i&&(yield new g(s,"vampire"))}function y(e,t,a){const s=[];for(let i=0;i<a;i+=1)s.push(f(e,t).next().value);return s}function C(e,t){let a=0;const s=[];if("player"!==e&&"computer"!==e)throw new Error('Параметр передаваемый в функцию generatePosition() должен быть "Player" либо "Computer"');"player"===e&&(a=0),"computer"===e&&(a=6);for(let e=0;e<8;e+=1)t.includes(8*e+a)||s.push(8*e+a),t.includes(8*e+a+1)||s.push(8*e+a+1);return s[Math.floor(Math.random()*s.length)]}function L(e,t){const a=[],s=[],i=[];let r;for(let a=t%8-e;a<=t%8+e;a+=1)a>=0&&a<8&&s.push(a);for(let a=Math.floor(t/8)-e;a<=Math.floor(t/8)+e;a+=1)a>=0&&a<8&&i.push(a);for(let l=-e;l<e+1;l+=1)for(let n=-e;n<e+1;n+=1)r=t+8*l+n,r!==t&&!a.includes(r)&&r>=0&&r<64&&s.indexOf(r%8)>=0&&i.indexOf(Math.floor(r/8))>=0&&a.push(r);return a}function w(e,t){let a=[];return"swordsman"!==e&&"undead"!==e||(a=L(1,t)),"bowman"!==e&&"vampire"!==e||(a=L(2,t)),"magician"!==e&&"daemon"!==e||(a=L(4,t)),a}function v(e,t,a){const s=a.map((e=>e.position)),i=[],r=[],l=[];let n=0;for(let a=t%8-e;a<=t%8+e;a+=1)a>=0&&a<8&&r.push(a);for(let a=Math.floor(t/8)-e;a<=Math.floor(t/8)+e;a+=1)a>=0&&a<8&&l.push(a);for(let a=-e;a<e+1;a+=1){const c=0===a?e:Math.abs(a),h=0===a?1:Math.abs(a);for(let e=-c;e<c+1;e+=h)n=t+8*a+e,n!==t&&!s.includes(n)&&Math.floor(n/8)===Math.floor(t/8)+a&&n>=0&&n<64&&r.indexOf(n%8)>=0&&l.indexOf(Math.floor(n/8))>=0&&i.push(n)}return i}function S(e,t,a){let s=[];return"swordsman"!==e&&"undead"!==e||(s=v(4,t,a)),"bowman"!==e&&"vampire"!==e||(s=v(2,t,a)),"magician"!==e&&"daemon"!==e||(s=v(1,t,a)),s}class T{constructor(e){this.characters=e}*[Symbol.iterator](){let e=0;for(;e<this.characters.length;)yield this.characters[e],e+=1}}class E{constructor(e,t){if(!(e instanceof h))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class b{constructor(){this.running=!0,this.level=1,this.turn="player",this.selectedCell=null,this.selectedCharacter=""}changeTurn(){this.turn="player"===this.turn?"computer":"player"}}const P=new e;P.bindToDOM(document.querySelector("#game-container"));const M=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),k=new class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.gameState=new b,this.playerTeam=[],this.computerTeam=[],this.characterList=[]}init(){this.startNewGame(),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.startNewGame.bind(this)),this.gamePlay.addSaveGameListener(this.saveGame.bind(this)),this.gamePlay.addLoadGameListener(this.loadGame.bind(this))}onCellClick(t){if(this.gameState.running){const a=this.characterList.find((e=>e.position===t)),s=S(this.gameState.selectedCharacter,this.gameState.selectedCell,this.characterList);if(a){const s=w(this.gameState.selectedCharacter,this.gameState.selectedCell);if("bowman"===a.character.type||"swordsman"===a.character.type||"magician"===a.character.type)this.gamePlay.deselectCell(this.gameState.selectedCell),this.gamePlay.selectCell(t,"yellow"),this.gameState.selectedCharacter=a.character.type,this.gameState.selectedCell=t;else if(s.indexOf(t)>=0){let s=this.characterList.find((e=>e.position===this.gameState.selectedCell)).character,i=a.character,r=Math.max(.2*(s.attack-i.defence),.1*s.attack);if(r=Math.floor(r),i.health-=r,i.health<1&&(this.computerTeam.length-=1,this.characterList=this.characterList.filter((e=>e.position!==t))),this.gamePlay.redrawPositions(this.characterList),0===this.computerTeam.length){if(4===this.gameState.level)return this.gameState.running=!1,void e.showMessage("Победа");this.gameState.level+=1,this.levelUp(),this.gameState.selectedCell=null,this.gameState.selectedCharacter="",this.startNextLevel()}this.gameState.running=!1,this.gamePlay.showDamage(t,r).then((()=>{setTimeout((()=>{this.gameState.changeTurn(),this.gameState.running=!0,this.enemyTurn()}),50)}))}else e.showError("Можно выделять только персонажей игрока")}else s.indexOf(t)>=0?(this.characterList.map((e=>{e.position===this.gameState.selectedCell&&(e.position=t,this.gamePlay.deselectCell(this.gameState.selectedCell),this.gameState.selectedCell=t,this.gamePlay.selectCell(t,"yellow"))})),this.gamePlay.redrawPositions(this.characterList),this.enemyTurn()):e.showError("Пустая клетка")}}onCellEnter(e){if(this.gameState.running){const t=this.characterList.find((t=>t.position===e));if(t){this.gamePlay.setCursor(l);const a=this.characterInf(t.character);this.gamePlay.showCellTooltip(a,e);const s=w(this.gameState.selectedCharacter,this.gameState.selectedCell);"undead"!==t.character.type&&"vampire"!==t.character.type&&"daemon"!==t.character.type||(s.indexOf(e)>=0?this.gamePlay.setCursor(n):this.gamePlay.setCursor(c))}else S(this.gameState.selectedCharacter,this.gameState.selectedCell,this.characterList).indexOf(e)>=0&&this.gamePlay.selectCell(e,"green")}}onCellLeave(e){this.gamePlay.hideCellTooltip(e),this.gamePlay.setCursor(r),e!==this.gameState.selectedCell&&this.gamePlay.deselectCell(e)}startNewGame(){this.clearAll(),this.startNextLevel()}saveGame(){const t={};t.running=this.gameState.running,t.level=this.gameState.level,t.turn=this.gameState.turn,t.selectedCell=this.gameState.selectedCell,t.selectedCharacter=this.gameState.selectedCharacter,t.playerTeam=this.playerTeam,t.computerTeam=this.computerTeam,t.characterList=this.characterList,this.stateService.save(t),e.showMessage("Game is saved")}loadGame(){try{const t=this.stateService.load();this.gameState.running=t.running,this.gameState.level=t.level,this.gameState.turn=t.turn,this.gamePlay.deselectCell(this.gameState.selectedCell),this.gameState.selectedCell=t.selectedCell,this.gameState.selectedCell&&this.gamePlay.selectCell(this.gameState.selectedCell,"yellow"),this.gameState.selectedCharacter=t.selectedCharacter,this.playerTeam=t.playerTeam,this.computerTeam=t.computerTeam,this.characterList=t.characterList,this.drawingPlan(this.gameState.level),this.gamePlay.redrawPositions(this.characterList),e.showMessage("Игра загружена")}catch{e.showError("Нет сохранённой игры")}}clearAll(){this.playerTeam=[],this.computerTeam=[],this.characterList=[],this.gameState.level=1,this.gameState.running=!0}startNextLevel(){this.drawingPlan(this.gameState.level),this.generateNewTeam("player"),this.generateNewTeam("computer"),this.positionTeam("player"),this.positionTeam("computer"),this.drawingCharacters()}drawingPlan(e){let r="";1===e&&(r=t),2===e&&(r=a),3===e&&(r=s),4===e&&(r=i),this.gamePlay.drawUi(r)}generateNewTeam(e){if("player"===e){const e=this.characterList.map((e=>e));this.playerTeam=[];for(let t of e)"bowman"!==t.character.type&&"swordsman"!==t.character.type&&"magician"!==t.character.type||(this.playerTeam.push(t.character),this.characterList.shift());const t=4-this.playerTeam.length;if(t){const e=y(["Bowman","Swordsman","Magician"],1,t);this.playerTeam=this.playerTeam.concat(...e)}}if("computer"===e){const e=this.characterList;this.computerTeam=[];for(let t of e)"undead"!==t.character.type&&"vampire"!==t.character.type&&"daemon"!==t.character.type||(this.computerTeam.push(t.character),this.characterList.shift());const t=4-this.computerTeam.length;if(t){const e=y(["Undead","Daemon","Vampire"],1,t);this.computerTeam=this.computerTeam.concat(e)}}}positionTeam(e){const t="player"===e?this.playerTeam:this.computerTeam,a=[];for(let s of t){const t=C(e,a);a.push(t);const i=new E(s,t);this.characterList.push(i)}}drawingCharacters(){this.gamePlay.redrawPositions(this.characterList)}levelUp(){let e=0;for(let t of this.characterList){const a=t.character;a.level+=1,a.attack=Math.max(a.attack,a.attack*(80+a.health)/100),a.attack=Math.floor(a.attack),a.defence=Math.max(a.defence,a.defence*(80+a.health)/100),a.defence=Math.floor(a.defence),a.health=a.health+80<=100?a.health+80:100,t.character=a,this.characterList[e]=t,e++}}characterInf(e){return`🎖${e.level} ⚔${e.attack} 🛡${e.defence} ❤${e.health}`}enemyTurn(){const e=[],t=[];let a={damage:0};for(let s of this.characterList)if("bowman"!==s.character.type&&"swordsman"!==s.character.type&&"magician"!==s.character.type||e.push(s),"undead"===s.character.type||"vampire"===s.character.type||"daemon"===s.character.type){const i=s.character,r=s.position;t.push(s);const l=w(s.character.type,s.position);for(let t of e)if(l.indexOf(t.position)>=0){let e=t.character,s=Math.max(.2*(i.attack-e.defence),.1*i.attack);s=Math.floor(s),s>a.damage&&(a.damage=s,a.attackerPosition=r,a.defenderPosition=t.position)}}if(a.damage>0){const t=this.characterList.find((e=>e.position===a.defenderPosition));return t.character.health-=a.damage,t.character.health<1&&(this.gameState.selectedCell=null,this.gameState.selectedCharacter="",this.gamePlay.deselectCell(t.position),this.playerTeam.length-=1,this.characterList=this.characterList.filter((e=>e.position!==t.position))),this.gameState.running=!1,this.gamePlay.showDamage(t.position,a.damage).then((()=>setTimeout((()=>{this.gameState.running=!0,this.gameState.changeTurn(),this.gamePlay.redrawPositions(this.characterList)}),100))),void((e.length=0)&&this.startNextLevel())}let s=Math.floor(Math.random()*this.computerTeam.length);const i=t[s],r=S(i.character.type,i.position,this.characterList);s=Math.floor(Math.random()*r.length),i.position=r[s],this.gamePlay.redrawPositions(this.characterList),console.log(r)}}(P,M);k.init()}();
//# sourceMappingURL=main.js.map